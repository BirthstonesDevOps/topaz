<div class="request-details-container">
    <div class="header">
        <p-button icon="pi pi-arrow-left" label="Volver" severity="secondary" text (click)="goBack()" class="back-button"> </p-button>
    </div>

    <div *ngIf="loading()" class="card">
        <div class="text-center">
            <p-progressSpinner [style]="{ width: '50px', height: '50px' }" strokeWidth="6" styleClass="custom-spinner"> </p-progressSpinner>
            <div class="mt-3 text-primary font-bold text-lg">Cargando...</div>
        </div>
    </div>

    <div *ngIf="!loading() && requestDetails() === null" class="card">
        <div class="text-center">
            <i class="pi pi-exclamation-triangle text-4xl mb-4" style="color: var(--text-color-secondary)"></i>
            <div class="font-bold text-xl mb-2" style="color: var(--text-color)">No se encontró el pedido solicitado</div>
            <div style="color: var(--text-color-secondary)">El pedido que estás buscando no existe o no tienes permisos para verlo.</div>
        </div>
    </div>

    <div *ngIf="!loading() && requestDetails() !== null" class="card">
        <!-- Header with Request ID -->
        <div class="content-header mb-4">
            <h1 class="text-2xl font-bold text-color mb-2">Detalles del Pedido</h1>
            <div class="request-id">
                <span class="text-color-secondary font-semibold">ID del Pedido:</span>
                <span class="text-primary font-bold text-lg ml-2">{{ requestDetails()?.id }}</span>
            </div>
        </div>

        <!-- Tabs Component -->
        <p-tabs [value]="0">
            <p-tablist>
                <p-tab [value]="0">Detalles</p-tab>
                <p-tab [value]="1">Estado</p-tab>
                <p-tab [value]="2">Órdenes</p-tab>
            </p-tablist>
            
            <p-tabpanels>
                <!-- Details Tab -->
                <p-tabpanel [value]="0">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
                        <div class="flex flex-col">
                            <label class="font-semibold text-sm text-color-secondary mb-2">DEPARTAMENTO</label>
                            <span class="text-lg font-medium text-color">{{ requestDetails()?.areaName || 'N/A' }}</span>
                        </div>
                        <div class="flex flex-col">
                            <label class="font-semibold text-sm text-color-secondary mb-2">CENTRO DE PRODUCCIÓN</label>
                            <span class="text-lg font-medium text-color">{{ requestDetails()?.locationName || 'N/A' }}</span>
                        </div>
                        <div class="flex flex-col">
                            <label class="font-semibold text-sm text-color-secondary mb-2">FECHA REQUERIDA</label>
                            <span class="text-lg font-medium text-color">{{ formatDate(requestDetails()?.neededAt) }}</span>
                        </div>
                        <div class="flex flex-col">
                            <label class="font-semibold text-sm text-color-secondary mb-2">FECHA DE CREACIÓN</label>
                            <span class="text-lg font-medium text-color">{{ formatDate(requestDetails()?.createdAt) }}</span>
                        </div>
                        <div class="flex flex-col">
                            <label class="font-semibold text-sm text-color-secondary mb-2">FECHA DE ACTUALIZACIÓN</label>
                            <span class="text-lg font-medium text-color">{{ formatDate(requestDetails()?.updatedAt || undefined) }}</span>
                        </div>
                        <div class="flex flex-col">
                            <label class="font-semibold text-sm text-color-secondary mb-2">ESTADO ACTUAL</label>
                            <span class="inline-flex">
                                <p-tag 
                                    [value]="requestDetails()?.currentStatus?.status || 'N/A'" 
                                    [severity]="requestDetails()?.currentStatus?.tag" 
                                    [icon]="'pi ' + (requestDetails()?.currentStatus?.icon || 'pi-circle')">
                                </p-tag>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Items Section -->
                    <div>
                        <app-item-list 
                            [items]="requestDetails()?.items || []"
                            [showMeasurement]="true"
                            [onItemSave]="canAddItems() ? addItemHandler : undefined"
                            [onItemEdit]="canEditItems() ? editItemHandler : undefined"
                            [onItemDelete]="canDeleteItems() ? deleteItemHandler : undefined">
                        </app-item-list>
                    </div>
                </p-tabpanel>

                <!-- Status Tab -->
                <p-tabpanel [value]="1">
                    <div class="p-4">
                        <app-status-note-tree 
                            [statusHistory]="requestDetails()?.statusHistory || []"
                            [onNoteAdd]="addNoteHandler">
                        </app-status-note-tree>
                    </div>
                </p-tabpanel>

                <!-- Orders Tab -->
                <p-tabpanel [value]="2">
                    <div class="tab-content">
                        <!-- Purchase Orders Section -->
                        <div class="info-section" *ngIf="requestDetails()?.purchaseOrders && requestDetails()!.purchaseOrders!.length > 0; else noPurchaseOrders">
                            <h3 class="text-lg font-semibold text-color mb-3">Órdenes de Compra ({{ requestDetails()!.purchaseOrders!.length }})</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div *ngFor="let po of requestDetails()?.purchaseOrders" class="po-card">
                                    <div class="po-id">ID de Orden: {{ po.id }}</div>
                                    <div class="po-details">
                                        <div *ngIf="po.orderNumber"><strong>Número de Orden:</strong> {{ po.orderNumber }}</div>
                                        <div *ngIf="po.providerId"><strong>ID del Proveedor:</strong> {{ po.providerId }}</div>
                                        <div *ngIf="po.createdAt"><strong>Creado:</strong> {{ formatDate(po.createdAt) }}</div>
                                        <div *ngIf="po.updatedAt"><strong>Actualizado:</strong> {{ formatDate(po.updatedAt || undefined) }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <ng-template #noPurchaseOrders>
                            <div class="text-center py-8">
                                <i class="pi pi-shopping-cart text-4xl mb-4" style="color: var(--text-color-secondary)"></i>
                                <div class="font-semibold text-lg mb-2" style="color: var(--text-color-secondary)">No hay Órdenes de Compra</div>
                                <div style="color: var(--text-color-secondary)">No se han creado órdenes de compra para este pedido aún.</div>
                            </div>
                        </ng-template>
                    </div>
                </p-tabpanel>
            </p-tabpanels>
        </p-tabs>
    </div>
</div>

<!-- Toast for notifications -->
<p-toast></p-toast>
